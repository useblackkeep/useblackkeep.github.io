<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com; img-src 'self' data: https:;">
    <title>BlackKeep — Encrypted Messenger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #08080d;
            --bg-elevated: #0e0e16;
            --bg-surface: #14141e;
            --fg: #e2e2f0;
            --fg-muted: #5a5a72;
            --fg-dim: #8a8aa8;
            --accent: #00d4ff;
            --accent-dim: rgba(0,212,255,0.12);
            --accent-glow: rgba(0,212,255,0.35);
            --success: #00ff88;
            --error: #ff3b5c;
            --warning: #ffb800;
            --border: #1e1e2e;
            --border-bright: #2e2e44;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--fg);
            font-size: 13px;
            line-height: 1.6;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 9999; opacity: 0.4;
        }

        /* LOADING */
        #loadingScreen {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 2000;
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        #loadingScreen.fade-out { opacity: 0; transform: scale(1.04); pointer-events: none; }
        #loadingScreen.hidden { display: none; }
        .loading-logo { font-size: 32px; font-weight: 700; letter-spacing: 0.2em; margin-bottom: 48px; position: relative; }
        .loading-logo .accent { color: var(--accent); }
        .loading-logo::after { content: ''; position: absolute; bottom: -8px; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: shimmer 2s ease infinite; }
        @keyframes shimmer { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
        .loading-bars { display: flex; gap: 4px; margin-bottom: 32px; }
        .loading-bar { width: 3px; background: var(--accent); border-radius: 2px; animation: barPulse 1.2s ease infinite; }
        .loading-bar:nth-child(1) { height: 16px; animation-delay: 0s; }
        .loading-bar:nth-child(2) { height: 28px; animation-delay: 0.15s; }
        .loading-bar:nth-child(3) { height: 40px; animation-delay: 0.3s; }
        .loading-bar:nth-child(4) { height: 28px; animation-delay: 0.45s; }
        .loading-bar:nth-child(5) { height: 16px; animation-delay: 0.6s; }
        @keyframes barPulse { 0%,100% { opacity: 0.2; transform: scaleY(0.6); } 50% { opacity: 1; transform: scaleY(1); } }
        .loading-text { font-size: 11px; color: var(--fg-muted); letter-spacing: 0.15em; text-transform: uppercase; animation: loadingTextCycle 3s ease infinite; }
        @keyframes loadingTextCycle { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* MAIN LAYOUT */
        .page { min-height: 100vh; display: flex; flex-direction: column; }

        /* NAV */
        nav {
            padding: 20px 40px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: rgba(8,8,13,0.9);
            backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-logo { font-size: 18px; font-weight: 700; letter-spacing: 0.15em; }
        .nav-logo .accent { color: var(--accent); }
        .nav-right { display: flex; gap: 12px; align-items: center; }
        .btn { padding: 10px 20px; border: 1px solid var(--border-bright); border-radius: 8px; background: var(--bg-surface); color: var(--fg); font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em; }
        .btn:hover { border-color: var(--accent); background: var(--bg-elevated); }
        .btn-primary { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 600; }
        .btn-primary:hover { background: #00bbdf; border-color: #00bbdf; box-shadow: 0 4px 16px var(--accent-glow); }

        /* HERO */
        .hero {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 80px 40px;
            position: relative; overflow: hidden;
        }
        .hero-grid {
            position: absolute; inset: 0;
            background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3; pointer-events: none;
        }
        .hero-glow {
            position: absolute; width: 800px; height: 800px;
            background: radial-gradient(circle, rgba(0,212,255,0.05) 0%, transparent 70%);
            pointer-events: none; animation: floatGlow 8s ease infinite;
            left: 50%; top: 50%; transform: translate(-50%,-50%);
        }
        @keyframes floatGlow { 0%,100% { transform: translate(-50%,-50%) translateY(0); } 50% { transform: translate(-50%,-50%) translateY(-30px); } }
        .hero-content { position: relative; z-index: 1; text-align: center; max-width: 700px; }
        .hero-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--accent-dim); border: 1px solid rgba(0,212,255,0.2);
            border-radius: 100px; padding: 6px 16px; font-size: 10px;
            color: var(--accent); letter-spacing: 0.15em; text-transform: uppercase;
            margin-bottom: 32px; animation: fadeSlideUp 0.6s ease 0.2s both;
        }
        .hero-badge-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; box-shadow: 0 0 0 0 var(--accent-glow); } 50% { opacity: 0.7; box-shadow: 0 0 0 6px transparent; } }
        .hero-title { font-size: clamp(40px, 7vw, 72px); font-weight: 700; letter-spacing: 0.1em; line-height: 1; margin-bottom: 8px; animation: fadeSlideUp 0.6s ease 0.3s both; }
        .hero-title .accent { color: var(--accent); }
        .hero-subtitle { font-family: 'Space Grotesk', sans-serif; font-size: clamp(16px, 2vw, 20px); color: var(--fg-dim); line-height: 1.6; margin-bottom: 16px; font-weight: 300; animation: fadeSlideUp 0.6s ease 0.4s both; }
        .hero-tagline { font-size: 11px; color: var(--fg-muted); font-style: italic; margin-bottom: 48px; padding: 12px 20px; border: 1px dashed var(--border-bright); border-radius: 6px; animation: fadeSlideUp 0.6s ease 0.5s both; display: inline-block; }
        .hero-features { display: flex; gap: 12px; margin-bottom: 48px; flex-wrap: wrap; justify-content: center; animation: fadeSlideUp 0.6s ease 0.6s both; }
        .feature-pill { display: flex; align-items: center; gap: 6px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; padding: 8px 14px; font-size: 11px; color: var(--fg-dim); }
        .feature-pill svg { color: var(--accent); flex-shrink: 0; }
        .hero-cta { display: flex; flex-direction: column; align-items: center; gap: 16px; animation: fadeSlideUp 0.6s ease 0.7s both; }
        .hero-cta-row { display: flex; gap: 12px; }
        .name-input-wrapper { width: 340px; }
        .name-input-wrapper label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.15em; color: var(--fg-muted); margin-bottom: 8px; text-align: left; }
        .name-input { width: 100%; background: var(--bg-elevated); border: 1px solid var(--border-bright); border-radius: 8px; padding: 14px 18px; color: var(--fg); font-family: 'Space Grotesk', sans-serif; font-size: 15px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        .name-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        .name-input::placeholder { color: var(--fg-muted); }
        .btn-get-started { padding: 14px 32px; background: var(--accent); border: none; border-radius: 8px; color: var(--bg); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; letter-spacing: 0.1em; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .btn-get-started:hover { transform: translateY(-1px); box-shadow: 0 8px 24px var(--accent-glow); background: #00bbdf; }
        .privacy-note { font-size: 10px; color: var(--fg-muted); text-align: center; display: flex; align-items: center; gap: 6px; }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        /* AUTH OVERLAY */
        #authOverlay {
            position: fixed; inset: 0;
            background: rgba(8,8,13,0.97);
            display: flex; align-items: center; justify-content: center;
            z-index: 500; padding: 20px;
            backdrop-filter: blur(16px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #authOverlay.visible { opacity: 1; pointer-events: all; }

        .auth-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-bright);
            border-radius: 14px;
            padding: 40px;
            width: 100%; max-width: 420px;
            position: relative;
            animation: cardIn 0.35s ease;
        }
        @keyframes cardIn { from { opacity: 0; transform: translateY(24px) scale(0.97); } to { opacity: 1; transform: none; } }

        .auth-header { margin-bottom: 28px; }
        .auth-logo { font-size: 20px; font-weight: 700; letter-spacing: 0.15em; margin-bottom: 6px; }
        .auth-logo .accent { color: var(--accent); }
        .auth-title { font-size: 22px; font-weight: 600; margin-bottom: 4px; }
        .auth-subtitle { font-size: 12px; color: var(--fg-muted); }

        .auth-close {
            position: absolute; top: 16px; right: 16px;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 8px; cursor: pointer; color: var(--fg-muted);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .auth-close:hover { border-color: var(--error); color: var(--error); }

        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--fg-muted); margin-bottom: 8px; }
        .input-field {
            width: 100%; background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 13px 16px; color: var(--fg);
            font-family: 'JetBrains Mono', monospace; font-size: 13px;
            outline: none; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        .input-field::placeholder { color: var(--fg-muted); }
        .input-field.error-field { border-color: var(--error); }

        .password-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--fg-muted); cursor: pointer; padding: 4px; display: flex; }
        .password-toggle:hover { color: var(--accent); }

        .auth-error { font-size: 11px; color: var(--error); margin-bottom: 16px; padding: 10px 14px; background: rgba(255,59,92,0.08); border: 1px solid rgba(255,59,92,0.2); border-radius: 6px; display: none; }
        .auth-error.visible { display: block; }

        .auth-btn { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 8px; color: var(--bg); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; letter-spacing: 0.08em; cursor: pointer; transition: all 0.2s; margin-top: 8px; position: relative; overflow: hidden; }
        .auth-btn:hover { background: #00bbdf; box-shadow: 0 6px 20px var(--accent-glow); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-btn .spinner { display: none; }
        .auth-btn.loading .btn-text { display: none; }
        .auth-btn.loading .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(8,8,13,0.3); border-top-color: var(--bg); border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .auth-switch { text-align: center; margin-top: 20px; font-size: 11px; color: var(--fg-muted); }
        .auth-switch a { color: var(--accent); text-decoration: none; cursor: pointer; }
        .auth-switch a:hover { text-decoration: underline; }

        .terms-checkbox { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 16px; }
        .terms-checkbox input[type="checkbox"] { width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px; accent-color: var(--accent); cursor: pointer; }
        .terms-checkbox label { font-size: 11px; color: var(--fg-muted); cursor: pointer; line-height: 1.5; }
        .terms-checkbox label a { color: var(--accent); text-decoration: none; }
        .terms-checkbox label a:hover { text-decoration: underline; }

        .password-strength { height: 3px; border-radius: 2px; margin-top: 6px; background: var(--border); overflow: hidden; }
        .password-strength-fill { height: 100%; border-radius: 2px; transition: width 0.3s, background 0.3s; width: 0%; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 2px; }

        @media (max-width: 600px) {
            nav { padding: 16px 20px; }
            .hero { padding: 40px 20px; }
            .name-input-wrapper { width: 100%; }
            .hero-cta-row { flex-direction: column; width: 100%; }
            .btn-get-started { width: 100%; padding: 14px; }
            .auth-card { padding: 28px 24px; }
        }
    </style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen">
    <div class="loading-logo">BLACK<span class="accent">KEEP</span></div>
    <div class="loading-bars">
        <div class="loading-bar"></div><div class="loading-bar"></div>
        <div class="loading-bar"></div><div class="loading-bar"></div>
        <div class="loading-bar"></div>
    </div>
    <div class="loading-text" id="loadingText">Initializing secure environment...</div>
</div>

<!-- AUTH OVERLAY -->
<div id="authOverlay">
    <div class="auth-card" id="authCard">
        <button class="auth-close" id="authClose" aria-label="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <div class="auth-header">
            <div class="auth-logo">BLACK<span class="accent">KEEP</span></div>
            <div class="auth-title" id="authTitle">Create Account</div>
            <div class="auth-subtitle" id="authSubtitle">Join the secure network</div>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signupForm">
            <div class="auth-error" id="signupError"></div>
            <div class="input-group">
                <label class="input-label" for="signupUsername">Username</label>
                <input type="text" class="input-field" id="signupUsername" placeholder="ShadowAgent42" maxlength="24" autocomplete="username" autocapitalize="none" spellcheck="false">
            </div>
            <div class="input-group">
                <label class="input-label" for="signupPassword">Password</label>
                <div class="password-wrapper">
                    <input type="password" class="input-field" id="signupPassword" placeholder="Min. 8 characters" autocomplete="new-password">
                    <button type="button" class="password-toggle" data-target="signupPassword" aria-label="Toggle password">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
                <div class="password-strength"><div class="password-strength-fill" id="strengthFill"></div></div>
            </div>
            <div class="terms-checkbox">
                <input type="checkbox" id="agreeTerms">
                <label for="agreeTerms">I agree to the <a href="https://docs.google.com/document/d/1J2GuJV1o7oLgcKj8u6R-jfTVi-ddr05XWb60mtj0C6c/edit?usp=sharing" target="_blank" rel="noopener">Terms of Use</a></label>
            </div>
            <button class="auth-btn" id="signupBtn">
                <span class="btn-text">CREATE ACCOUNT</span>
                <span class="spinner"></span>
            </button>
            <div class="auth-switch">Already have an account? <a id="switchToLogin">Sign in</a></div>
        </div>

        <!-- LOGIN FORM -->
        <div id="loginForm" style="display:none;">
            <div class="auth-error" id="loginError"></div>
            <div class="input-group">
                <label class="input-label" for="loginUsername">Username</label>
                <input type="text" class="input-field" id="loginUsername" placeholder="Your username" autocomplete="username" autocapitalize="none" spellcheck="false">
            </div>
            <div class="input-group">
                <label class="input-label" for="loginPassword">Password</label>
                <div class="password-wrapper">
                    <input type="password" class="input-field" id="loginPassword" placeholder="Your password" autocomplete="current-password">
                    <button type="button" class="password-toggle" data-target="loginPassword" aria-label="Toggle password">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
            </div>
            <button class="auth-btn" id="loginBtn">
                <span class="btn-text">SIGN IN</span>
                <span class="spinner"></span>
            </button>
            <div class="auth-switch">No account? <a id="switchToSignup">Create one</a></div>
        </div>
    </div>
</div>

<!-- MAIN PAGE -->
<div class="page" id="mainPage" style="opacity:0; transition: opacity 0.5s;">
    <nav>
        <div class="nav-logo">BLACK<span class="accent">KEEP</span></div>
        <div class="nav-right">
            <button class="btn" id="navLoginBtn">Sign In</button>
            <button class="btn btn-primary" id="navSignupBtn">Get Started</button>
        </div>
    </nav>

    <section class="hero">
        <div class="hero-grid"></div>
        <div class="hero-glow"></div>
        <div class="hero-content">
            <div class="hero-badge">
                <div class="hero-badge-dot"></div>
                End-to-End Encrypted
            </div>
            <div class="hero-title">BLACK<span class="accent">KEEP</span></div>
            <div class="hero-subtitle">Encrypted messaging, built for those who value privacy.</div>
            <div class="hero-tagline">"Breaking this encryption would require more energy than exists in the observable universe."</div>
            <div class="hero-features">
                <div class="feature-pill">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    End-to-End Encrypted
                </div>
                <div class="feature-pill">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Friends & Groups
                </div>
                <div class="feature-pill">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    Disappearing Messages
                </div>
                <div class="feature-pill">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Real-time & Secure
                </div>
                <div class="feature-pill">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    Games & Reactions
                </div>
            </div>
            <div class="hero-cta">
                <div class="name-input-wrapper">
                    <label for="heroUsernameInput">Your Username</label>
                    <input type="text" id="heroUsernameInput" class="name-input" placeholder="ShadowAgent42" maxlength="24" autocomplete="off" spellcheck="false" autocapitalize="none">
                </div>
                <div class="hero-cta-row">
                    <button class="btn-get-started" id="heroGetStarted">GET STARTED →</button>
                </div>
                <div class="privacy-note">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Your messages are secured with AES-256-GCM encryption
                </div>
            </div>
        </div>
    </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="db.js"></script>
<script src="auth.js"></script>
<script>
'use strict';

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function boot() {
    const loading = document.getElementById('loadingScreen');
    const mainPage = document.getElementById('mainPage');
    const loadingText = document.getElementById('loadingText');

    const texts = ['Initializing secure environment...', 'Loading cryptographic modules...', 'Checking session...'];
    let i = 0;
    const textInterval = setInterval(() => { if (i < texts.length) loadingText.textContent = texts[i++]; }, 600);

    await sleep(1800);
    clearInterval(textInterval);

    // Check existing session
    const session = Auth.getSessionSync();
    if (session) {
        loadingText.textContent = 'Session found — redirecting...';
        await sleep(400);
        const valid = await Auth.getSession();
        if (valid) {
            window.location.href = 'app.html';
            return;
        }
    }

    loading.classList.add('fade-out');
    await sleep(600);
    loading.classList.add('hidden');
    mainPage.style.opacity = '1';
}

// Auth overlay logic
const overlay = document.getElementById('authOverlay');
const signupForm = document.getElementById('signupForm');
const loginForm = document.getElementById('loginForm');
const authTitle = document.getElementById('authTitle');
const authSubtitle = document.getElementById('authSubtitle');

let currentMode = 'signup';

function openAuth(mode, prefillUsername = '') {
    currentMode = mode;
    if (mode === 'signup') {
        signupForm.style.display = 'block';
        loginForm.style.display = 'none';
        authTitle.textContent = 'Create Account';
        authSubtitle.textContent = 'Join the secure network';
        if (prefillUsername) document.getElementById('signupUsername').value = prefillUsername;
    } else {
        signupForm.style.display = 'none';
        loginForm.style.display = 'block';
        authTitle.textContent = 'Welcome Back';
        authSubtitle.textContent = 'Sign in to your account';
        if (prefillUsername) document.getElementById('loginUsername').value = prefillUsername;
    }
    overlay.classList.add('visible');
    setTimeout(() => {
        const inp = mode === 'signup'
            ? (prefillUsername ? document.getElementById('signupPassword') : document.getElementById('signupUsername'))
            : (prefillUsername ? document.getElementById('loginPassword') : document.getElementById('loginUsername'));
        inp && inp.focus();
    }, 100);
}

document.getElementById('authClose').addEventListener('click', () => overlay.classList.remove('visible'));
overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('visible'); });

document.getElementById('switchToLogin').addEventListener('click', () => openAuth('login'));
document.getElementById('switchToSignup').addEventListener('click', () => openAuth('signup'));
document.getElementById('navLoginBtn').addEventListener('click', () => openAuth('login'));
document.getElementById('navSignupBtn').addEventListener('click', () => openAuth('signup'));

document.getElementById('heroGetStarted').addEventListener('click', async () => {
    const username = document.getElementById('heroUsernameInput').value.trim();
    if (!username) { openAuth('signup'); return; }
    // Check if username exists
    try {
        const existing = await DB.get('usernames/' + username);
        openAuth(existing ? 'login' : 'signup', username);
    } catch { openAuth('signup', username); }
});

// Password strength
document.getElementById('signupPassword').addEventListener('input', function() {
    const p = this.value;
    const fill = document.getElementById('strengthFill');
    let score = 0;
    if (p.length >= 8) score++;
    if (p.length >= 12) score++;
    if (/[A-Z]/.test(p)) score++;
    if (/[0-9]/.test(p)) score++;
    if (/[^A-Za-z0-9]/.test(p)) score++;
    const colors = ['#ff3b5c','#ff3b5c','#ffb800','#ffb800','#00ff88'];
    fill.style.width = (score * 20) + '%';
    fill.style.background = colors[Math.max(0, score-1)] || '#ff3b5c';
});

// Password toggle
document.querySelectorAll('.password-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.target);
        target.type = target.type === 'password' ? 'text' : 'password';
    });
});

function showError(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.add('visible');
}
function clearError(id) { document.getElementById(id).classList.remove('visible'); }

function setLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    btn.disabled = loading;
    btn.classList.toggle('loading', loading);
}

// Enter key
['signupUsername','signupPassword'].forEach(id => {
    document.getElementById(id)?.addEventListener('keydown', e => {
        if (e.key === 'Enter') doSignup();
    });
});
['loginUsername','loginPassword'].forEach(id => {
    document.getElementById(id)?.addEventListener('keydown', e => {
        if (e.key === 'Enter') doLogin();
    });
});

async function doSignup() {
    clearError('signupError');
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value;
    const agreed = document.getElementById('agreeTerms').checked;

    if (!username) { showError('signupError', 'Username is required'); return; }
    if (!password) { showError('signupError', 'Password is required'); return; }
    if (!agreed) { showError('signupError', 'You must agree to the Terms of Use'); return; }

    setLoading('signupBtn', true);
    try {
        await Auth.signUp(username, password);
        window.location.href = 'app.html';
    } catch (err) {
        showError('signupError', err.message);
        setLoading('signupBtn', false);
    }
}

async function doLogin() {
    clearError('loginError');
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) { showError('loginError', 'All fields required'); return; }

    setLoading('loginBtn', true);
    try {
        await Auth.signIn(username, password);
        window.location.href = 'app.html';
    } catch (err) {
        showError('loginError', err.message);
        setLoading('loginBtn', false);
    }
}

document.getElementById('signupBtn').addEventListener('click', doSignup);
document.getElementById('loginBtn').addEventListener('click', doLogin);

boot();
</script>
</body>
</html>
