<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://www.gstatic.com; img-src 'self' data: blob:; media-src 'self' data: blob:;">>
    <title>BlackKeep</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #08080d;
            --bg-elevated: #0e0e16;
            --bg-surface: #14141e;
            --bg-glass: rgba(14,14,22,0.85);
            --fg: #e2e2f0;
            --fg-muted: #5a5a72;
            --fg-dim: #8a8aa8;
            --accent: #00d4ff;
            --accent-dim: rgba(0,212,255,0.12);
            --accent-glow: rgba(0,212,255,0.35);
            --accent2: #7c3aed;
            --success: #00ff88;
            --error: #ff3b5c;
            --warning: #ffb800;
            --border: #1e1e2e;
            --border-bright: #2e2e44;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--fg);
            font-size: 13px;
            line-height: 1.6;
        }

        /* ===================== NOISE TEXTURE OVERLAY ===================== */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
            opacity: 0.4;
        }

        /* ===================== LOADING SCREEN ===================== */
        #loadingScreen {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 1000;
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        #loadingScreen.fade-out {
            opacity: 0; transform: scale(1.04); pointer-events: none;
        }

        .loading-logo {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 0.2em;
            margin-bottom: 48px;
            position: relative;
        }
        .loading-logo .accent { color: var(--accent); }

        .loading-logo::after {
            content: '';
            position: absolute;
            bottom: -8px; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: shimmer 2s ease infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; } 50% { opacity: 1; }
        }

        .loading-bars {
            display: flex; gap: 4px; margin-bottom: 32px;
        }
        .loading-bar {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            animation: barPulse 1.2s ease infinite;
        }
        .loading-bar:nth-child(1) { height: 16px; animation-delay: 0s; }
        .loading-bar:nth-child(2) { height: 28px; animation-delay: 0.15s; }
        .loading-bar:nth-child(3) { height: 40px; animation-delay: 0.3s; }
        .loading-bar:nth-child(4) { height: 28px; animation-delay: 0.45s; }
        .loading-bar:nth-child(5) { height: 16px; animation-delay: 0.6s; }

        @keyframes barPulse {
            0%, 100% { opacity: 0.2; transform: scaleY(0.6); }
            50% { opacity: 1; transform: scaleY(1); }
        }

        .loading-text {
            font-size: 11px;
            color: var(--fg-muted);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            animation: loadingTextCycle 3s ease infinite;
        }

        @keyframes loadingTextCycle { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* ===================== WELCOME SCREEN ===================== */
        #welcomeScreen {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 500;
            padding: 32px;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        #welcomeScreen.hidden {
            opacity: 0; transform: translateY(-20px); pointer-events: none;
        }

        .welcome-grid {
            position: absolute; inset: 0;
            background-image:
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
            pointer-events: none;
        }

        .welcome-glow {
            position: absolute;
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(0,212,255,0.06) 0%, transparent 70%);
            pointer-events: none;
            animation: floatGlow 8s ease infinite;
        }

        @keyframes floatGlow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }

        .welcome-content {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            align-items: center; text-align: center;
            max-width: 560px;
        }

        .welcome-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--accent-dim);
            border: 1px solid rgba(0,212,255,0.2);
            border-radius: 100px;
            padding: 6px 16px;
            font-size: 10px;
            color: var(--accent);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 32px;
            animation: fadeSlideUp 0.6s ease 0.2s both;
        }

        .welcome-badge-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 var(--accent-glow); }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px transparent; } }

        .welcome-title {
            font-size: clamp(36px, 6vw, 64px);
            font-weight: 700;
            letter-spacing: 0.1em;
            line-height: 1;
            margin-bottom: 8px;
            animation: fadeSlideUp 0.6s ease 0.3s both;
        }

        .welcome-title .accent { color: var(--accent); }

        .welcome-subtitle {
            font-family: 'Space Grotesk', sans-serif;
            font-size: clamp(15px, 2vw, 18px);
            color: var(--fg-dim);
            line-height: 1.6;
            margin-bottom: 16px;
            font-weight: 300;
            animation: fadeSlideUp 0.6s ease 0.4s both;
        }

        .welcome-tagline {
            font-size: 11px;
            color: var(--fg-muted);
            font-style: italic;
            letter-spacing: 0.03em;
            margin-bottom: 48px;
            padding: 12px 20px;
            border: 1px dashed var(--border-bright);
            border-radius: 6px;
            animation: fadeSlideUp 0.6s ease 0.5s both;
        }

        .welcome-features {
            display: flex; gap: 12px;
            margin-bottom: 48px;
            flex-wrap: wrap; justify-content: center;
            animation: fadeSlideUp 0.6s ease 0.6s both;
        }

        .feature-pill {
            display: flex; align-items: center; gap: 6px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 11px;
            color: var(--fg-dim);
        }

        .feature-pill svg { color: var(--accent); flex-shrink: 0; }

        .welcome-cta {
            display: flex; flex-direction: column; align-items: center; gap: 16px;
            animation: fadeSlideUp 0.6s ease 0.7s both;
            width: 100%; max-width: 340px;
        }

        .name-input-wrapper {
            width: 100%; position: relative;
        }

        .name-input-wrapper label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--fg-muted);
            margin-bottom: 8px;
        }

        .name-input {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-bright);
            border-radius: 8px;
            padding: 14px 18px;
            color: var(--fg);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .name-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .name-input::placeholder { color: var(--fg-muted); }

        .btn-get-started {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: var(--bg);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-get-started::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
        }

        .btn-get-started:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px var(--accent-glow);
        }

        .btn-get-started:active { transform: translateY(0); }

        .privacy-note {
            font-size: 10px;
            color: var(--fg-muted);
            text-align: center;
            display: flex; align-items: center; gap: 6px;
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===================== JOIN/CREATE MODAL ===================== */
        #joinModal {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 400; padding: 32px;
            transition: opacity 0.4s ease;
        }
        #joinModal.hidden { display: none; }

        .join-grid {
            position: absolute; inset: 0;
            background-image:
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3; pointer-events: none;
        }

        .join-card {
            position: relative; z-index: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border-bright);
            border-radius: 12px;
            padding: 36px;
            width: 100%; max-width: 420px;
            animation: cardIn 0.4s ease;
        }

        @keyframes cardIn {
            from { opacity: 0; transform: translateY(20px) scale(0.97); }
            to { opacity: 1; transform: none; }
        }

        .join-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }

        .join-logo { font-size: 18px; font-weight: 700; letter-spacing: 0.15em; }
        .join-logo .accent { color: var(--accent); }

        .join-user-badge {
            font-size: 11px;
            color: var(--accent);
            background: var(--accent-dim);
            border: 1px solid rgba(0,212,255,0.2);
            padding: 4px 10px; border-radius: 100px;
        }

        .join-subtitle {
            font-size: 11px;
            color: var(--fg-muted);
            margin-bottom: 28px;
        }

        .input-group { margin-bottom: 16px; }

        .input-label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--fg-muted);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 13px 16px;
            color: var(--fg);
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            text-align: center;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        .input-field::placeholder {
            color: var(--fg-muted);
            letter-spacing: 0.1em;
            font-size: 13px;
        }

        .modal-actions { display: flex; gap: 10px; margin-top: 24px; }
        .modal-actions .btn { flex: 1; }

        .modal-divider {
            display: flex; align-items: center; gap: 14px;
            margin: 20px 0; color: var(--fg-muted); font-size: 10px;
        }
        .modal-divider::before, .modal-divider::after {
            content: ''; flex: 1; height: 1px; background: var(--border);
        }

        .btn {
            padding: 12px 20px;
            border: 1px solid var(--border-bright);
            border-radius: 8px;
            background: var(--bg-surface);
            color: var(--fg);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            letter-spacing: 0.05em;
        }
        .btn:hover { border-color: var(--accent); background: var(--bg-elevated); }
        .btn:active { transform: scale(0.98); }
        .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        .btn-primary {
            background: var(--accent); color: var(--bg);
            border-color: var(--accent); font-weight: 600;
        }
        .btn-primary:hover {
            background: #00bbdf; border-color: #00bbdf;
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .btn-danger { border-color: var(--error); color: var(--error); }
        .btn-danger:hover { background: var(--error); color: var(--bg); }

        .btn-icon {
            padding: 11px;
            display: flex; align-items: center; justify-content: center;
        }

        /* ===================== CONNECTION OVERLAY ===================== */
        #connectionOverlay {
            position: fixed; inset: 0;
            background: rgba(8,8,13,0.96);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 600;
            backdrop-filter: blur(12px);
        }
        #connectionOverlay.hidden { display: none; }

        .conn-terminal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-bright);
            border-radius: 8px;
            padding: 24px;
            width: 100%; max-width: 440px;
        }

        .conn-terminal-bar {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 20px;
        }

        .term-dot {
            width: 10px; height: 10px; border-radius: 50%;
        }

        .term-dot:nth-child(1) { background: #ff5f57; }
        .term-dot:nth-child(2) { background: #ffbd2e; }
        .term-dot:nth-child(3) { background: #28ca41; }

        .conn-terminal-title {
            font-size: 11px; color: var(--fg-muted);
            letter-spacing: 0.1em; margin-left: 4px;
        }

        .status-line {
            font-size: 12px;
            color: var(--fg-muted);
            opacity: 0;
            transform: translateX(-8px);
            transition: all 0.35s ease;
            padding: 3px 0;
        }
        .status-line.visible { opacity: 1; transform: none; }
        .status-line.success { color: var(--success); }
        .status-line.error { color: var(--error); }
        .status-line .prefix { color: var(--accent); margin-right: 8px; }

        /* ===================== PURGE OVERLAY ===================== */
        #purgeOverlay {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 700;
        }
        #purgeOverlay.hidden { display: none; }

        .purge-icon {
            width: 64px; height: 64px;
            border-radius: 50%;
            background: rgba(255,59,92,0.1);
            border: 1px solid rgba(255,59,92,0.3);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 24px;
            animation: purgeScale 0.5s ease;
        }
        @keyframes purgeScale {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .purge-text { font-size: 18px; color: var(--error); letter-spacing: 0.1em; margin-bottom: 8px; }
        .purge-subtext { font-size: 12px; color: var(--success); }

        /* ===================== MAIN APP ===================== */
        .app-container {
            display: flex; flex-direction: column;
            height: 100vh; max-width: 1280px;
            margin: 0 auto;
        }

        .header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center;
            justify-content: space-between;
            background: var(--bg-elevated);
            flex-shrink: 0;
        }

        .logo { font-size: 16px; font-weight: 700; letter-spacing: 0.15em; }
        .logo .accent { color: var(--accent); }

        .header-right {
            display: flex; align-items: center; gap: 12px;
        }

        .room-code-display {
            font-size: 11px; color: var(--fg-muted);
            background: var(--bg-surface);
            padding: 6px 12px; border-radius: 6px;
            border: 1px solid var(--border);
        }
        .room-code-display strong { color: var(--accent); font-weight: 500; }

        .status-indicator {
            display: flex; align-items: center; gap: 8px;
            font-size: 11px; color: var(--fg-muted);
        }

        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--fg-muted);
            transition: background 0.3s, box-shadow 0.3s;
        }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.connecting {
            background: var(--warning);
            animation: dotPulse 1s infinite;
        }
        .status-dot.error { background: var(--error); }

        @keyframes dotPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .main-content {
            flex: 1; display: flex; overflow: hidden;
        }

        /* ===================== SIDEBAR ===================== */
        .sidebar {
            width: 200px;
            border-right: 1px solid var(--border);
            background: var(--bg-elevated);
            display: flex; flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-section {
            padding: 10px 14px 6px;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--fg-muted);
            border-bottom: 1px solid var(--border);
        }

        .peer-list {
            flex: 1; overflow-y: auto; padding: 8px;
        }

        .peer-item {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 11px; border-radius: 6px;
            margin-bottom: 2px;
            transition: background 0.2s;
        }
        .peer-item:hover { background: var(--bg-surface); }

        .peer-avatar {
            width: 28px; height: 28px; border-radius: 6px;
            background: var(--accent-dim);
            border: 1px solid rgba(0,212,255,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 600; color: var(--accent);
            flex-shrink: 0;
        }

        .peer-name {
            font-size: 12px; color: var(--fg);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .peer-status { font-size: 10px; color: var(--success); }

        .empty-peers {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 32px 16px; text-align: center;
        }
        .empty-peers svg { color: var(--fg-muted); opacity: 0.3; margin-bottom: 12px; }
        .empty-peers span { font-size: 11px; color: var(--fg-muted); }

        /* ===================== CHAT AREA ===================== */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background: var(--bg); min-width: 0;
        }

        .messages-container {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 2px;
        }

        .message {
            display: flex; flex-direction: column;
            animation: msgIn 0.25s ease;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: none; }
        }

        .message.self { align-items: flex-end; }

        .message-header {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 4px; padding: 0 2px;
        }

        .message.self .message-header { flex-direction: row-reverse; }

        .message-sender {
            font-size: 11px; font-weight: 600; color: var(--accent);
        }
        .message.self .message-sender { color: var(--success); }
        .message-time { font-size: 10px; color: var(--fg-muted); }

        .message-bubble {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 13px; color: var(--fg);
            max-width: min(70%, 480px);
            word-break: break-word;
        }

        .message.self .message-bubble {
            background: var(--bg-surface);
            border-color: var(--border-bright);
        }

        /* File bubble */
        .file-bubble {
            display: flex; align-items: center; gap: 12px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .file-bubble:hover { border-color: var(--accent); background: var(--bg-surface); }

        .file-icon {
            width: 36px; height: 36px; border-radius: 6px;
            background: var(--accent-dim);
            display: flex; align-items: center; justify-content: center;
            color: var(--accent); flex-shrink: 0;
        }

        .file-meta { flex: 1; min-width: 0; }
        .file-name { font-size: 12px; color: var(--fg); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-size { font-size: 10px; color: var(--fg-muted); }

        /* Image bubble */
        .image-bubble {
            padding: 6px;
            cursor: pointer;
            max-width: min(280px, 60vw);
        }

        .image-preview {
            width: 100%;
            border-radius: 4px;
            display: block;
            object-fit: cover;
            max-height: 200px;
            transition: opacity 0.2s;
        }
        .image-preview:hover { opacity: 0.85; }

        /* Video bubble */
        .video-bubble {
            padding: 6px;
            cursor: pointer;
            max-width: min(320px, 70vw);
        }

        .video-preview {
            width: 100%;
            border-radius: 4px;
            display: block;
            max-height: 200px;
            background: #000;
        }

        /* System message */
        .system-msg {
            text-align: center;
            font-size: 10px;
            color: var(--fg-muted);
            padding: 6px 14px;
            background: var(--bg-elevated);
            border: 1px dashed var(--border);
            border-radius: 6px;
            margin: 8px auto;
            max-width: 400px;
        }
        .system-msg.error { color: var(--error); border-color: rgba(255,59,92,0.3); }
        .system-msg.success { color: var(--success); border-color: rgba(0,255,136,0.3); }

        /* ===================== INPUT AREA ===================== */
        .input-area {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-elevated);
            flex-shrink: 0;
        }

        .input-row {
            display: flex; gap: 8px; align-items: center;
        }

        .message-input {
            flex: 1;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 11px 16px;
            color: var(--fg);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .message-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        .message-input::placeholder { color: var(--fg-muted); }

        .ratchet-bar {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 8px;
            padding: 0 2px;
        }
        .ratchet-label {
            font-size: 9px;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .ratchet-progress {
            flex: 1; height: 2px;
            background: var(--border);
            border-radius: 1px;
            overflow: hidden;
        }
        .ratchet-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 1px;
            transition: width 1s linear;
        }
        .ratchet-timer {
            font-size: 9px;
            color: var(--accent);
        }

        /* ===================== MEDIA VIEWER ===================== */
        #mediaViewer {
            position: fixed; inset: 0;
            background: rgba(8,8,13,0.97);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 800;
            backdrop-filter: blur(16px);
        }
        #mediaViewer.hidden { display: none; }

        .media-viewer-toolbar {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 16px 24px;
            display: flex; align-items: center; justify-content: between;
            background: linear-gradient(to bottom, rgba(8,8,13,0.9), transparent);
        }

        .media-viewer-name {
            flex: 1; font-size: 12px; color: var(--fg-dim);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .media-viewer-close {
            background: var(--bg-elevated);
            border: 1px solid var(--border-bright);
            border-radius: 8px;
            padding: 8px;
            color: var(--fg);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
        }
        .media-viewer-close:hover { border-color: var(--error); color: var(--error); }

        .media-viewer-content {
            max-width: 90vw; max-height: 85vh;
            display: flex; align-items: center; justify-content: center;
        }

        .media-viewer-content img {
            max-width: 100%; max-height: 85vh;
            border-radius: 6px;
            object-fit: contain;
            box-shadow: 0 32px 80px rgba(0,0,0,0.7);
        }

        .media-viewer-content video {
            max-width: 100%; max-height: 85vh;
            border-radius: 6px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.7);
        }

        /* ===================== SCROLLBAR ===================== */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--fg-muted); }

        /* ===================== UTILITIES ===================== */
        .hidden { display: none !important; }
        .file-input-hidden { display: none; }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>

<!-- ===================== LOADING SCREEN ===================== -->
<div id="loadingScreen">
    <div class="loading-logo">BLACK<span class="accent">KEEP</span></div>
    <div class="loading-bars">
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
    </div>
    <div class="loading-text">Initializing secure environment...</div>
</div>

<!-- ===================== WELCOME SCREEN ===================== -->
<div id="welcomeScreen" class="hidden">
    <div class="welcome-grid"></div>
    <div class="welcome-glow"></div>
    <div class="welcome-content">
        <div class="welcome-badge">
            <div class="welcome-badge-dot"></div>
            End-to-End Encrypted
        </div>
        <div class="welcome-title">BLACK<span class="accent">KEEP</span></div>
        <div class="welcome-subtitle">Modern peer-to-peer encrypted messaging, backed by cryptographic algorithms.</div>
        <div class="welcome-tagline">
            "Breaking this encryption would require more energy than exists in the observable universe."
        </div>
        <div class="welcome-features">
            <div class="feature-pill">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                X25519 + AES-256-GCM
            </div>
            <div class="feature-pill">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Zero Server Storage
            </div>
            <div class="feature-pill">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
                Key Ratcheting
            </div>
            <div class="feature-pill">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                Direct P2P Transfer
            </div>
        </div>
        <div class="welcome-cta">
            <div class="name-input-wrapper">
                <label for="displayNameInput">Your Display Name</label>
                <input type="text" id="displayNameInput" class="name-input"
                    placeholder="ShadowAgent42" maxlength="24"
                    autocomplete="off" spellcheck="false">
            </div>
            <button class="btn-get-started" id="getStartedBtn">GET STARTED →</button>
            <div class="privacy-note">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Your name is never stored — exchanged peer-to-peer only
            </div>
        </div>
    </div>
</div>

<!-- ===================== JOIN / CREATE MODAL ===================== -->
<div id="joinModal" class="hidden">
    <div class="join-grid"></div>
    <div class="join-card">
        <div class="join-header">
            <div class="join-logo">BLACK<span class="accent">KEEP</span></div>
            <div class="join-user-badge" id="joinUserBadge">Anonymous</div>
        </div>
        <div class="join-subtitle">Enter a room code to join, or create a new secure room.</div>

        <div class="input-group">
            <label class="input-label" for="roomCodeInput">Room Code</label>
            <input type="text" class="input-field" id="roomCodeInput"
                maxlength="8" placeholder="XXXXXXXX"
                autocomplete="off" spellcheck="false">
        </div>

        <div class="modal-actions">
            <button class="btn btn-primary" id="joinBtn">Join Room</button>
        </div>

        <div class="modal-divider">or</div>

        <button class="btn" id="createBtn" style="width:100%;">+ Create New Room</button>
    </div>
</div>

<!-- ===================== CONNECTION OVERLAY ===================== -->
<div id="connectionOverlay" class="hidden">
    <div class="conn-terminal">
        <div class="conn-terminal-bar">
            <div class="term-dot"></div>
            <div class="term-dot"></div>
            <div class="term-dot"></div>
            <span class="conn-terminal-title">blackkeep-handshake</span>
        </div>
        <div id="statusLines"></div>
    </div>
</div>

<!-- ===================== PURGE OVERLAY ===================== -->
<div id="purgeOverlay" class="hidden">
    <div class="purge-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ff3b5c" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            <line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/>
        </svg>
    </div>
    <div class="purge-text">[!] ROOM PURGED</div>
    <div class="purge-subtext">[+] Memory zeroized. Keys destroyed.</div>
</div>

<!-- ===================== MEDIA VIEWER ===================== -->
<div id="mediaViewer" class="hidden">
    <div class="media-viewer-toolbar">
        <span class="media-viewer-name" id="mediaViewerName"></span>
        <button class="media-viewer-close" id="mediaViewerClose" aria-label="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>
    <div class="media-viewer-content" id="mediaViewerContent"></div>
</div>

<!-- ===================== MAIN APP ===================== -->
<div class="app-container" id="app">
    <header class="header">
        <div class="logo">BLACK<span class="accent">KEEP</span></div>
        <div class="header-right">
            <div class="room-code-display" id="roomCodeDisplay">Room: <strong>--------</strong></div>
            <div class="status-indicator">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText">Disconnected</span>
            </div>
            <button class="btn btn-danger btn-icon" id="leaveBtn" title="Leave Room" aria-label="Leave Room">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16,17 21,12 16,7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </div>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="sidebar-section">Peers Online</div>
            <div class="peer-list" id="peerList">
                <div class="empty-peers" id="emptyPeers">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>No peers connected</span>
                </div>
            </div>
        </aside>

        <section class="chat-area">
            <div class="messages-container" id="messagesContainer"></div>

            <div class="input-area">
                <div class="ratchet-bar" id="ratchetBar" style="display:none;">
                    <span class="ratchet-label">Key Rotation</span>
                    <div class="ratchet-progress">
                        <div class="ratchet-fill" id="ratchetFill" style="width:100%"></div>
                    </div>
                    <span class="ratchet-timer" id="ratchetTimer">60s</span>
                </div>
                <div class="input-row">
                    <input type="file" class="file-input-hidden" id="fileInput"
                        accept="*/*" aria-label="Select file">
                    <button class="btn btn-icon" id="attachBtn" title="Attach file" aria-label="Attach file">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                        </svg>
                    </button>
                    <input type="text" class="message-input" id="messageInput"
                        placeholder="Type a message..." autocomplete="off" aria-label="Message input">
                    <button class="btn btn-primary" id="sendBtn">Send</button>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="crypto.js"></script>
<script src="FirebaseAPI.js"></script>
<script>
'use strict';

const BlackKeep = (function() {
    const PEER_ID_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const PEER_ID_LENGTH = 8;
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    const RATCHET_INTERVAL = 60000;
    const DUMMY_TRAFFIC_INTERVAL = 8000;
    const ICE_SERVERS = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
    ];

    let state = {
        roomId: null,
        peerId: null,
        displayName: null,
        cryptoContext: null,
        connections: new Map(),
        dataChannels: new Map(),
        peerNames: new Map(),
        ratchetTimer: null,
        dummyTrafficTimer: null,
        ratchetCountdown: 60,
        countdownTimer: null,
        unsubscribeSignals: null,
        isJoined: false,
        pendingCandidates: new Map()
    };

    let dom = {};

    function initDOM() {
        dom = {
            loadingScreen: document.getElementById('loadingScreen'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            displayNameInput: document.getElementById('displayNameInput'),
            getStartedBtn: document.getElementById('getStartedBtn'),
            joinModal: document.getElementById('joinModal'),
            joinUserBadge: document.getElementById('joinUserBadge'),
            connectionOverlay: document.getElementById('connectionOverlay'),
            purgeOverlay: document.getElementById('purgeOverlay'),
            statusLines: document.getElementById('statusLines'),
            roomCodeInput: document.getElementById('roomCodeInput'),
            joinBtn: document.getElementById('joinBtn'),
            createBtn: document.getElementById('createBtn'),
            leaveBtn: document.getElementById('leaveBtn'),
            roomCodeDisplay: document.getElementById('roomCodeDisplay'),
            connectionDot: document.getElementById('connectionDot'),
            connectionText: document.getElementById('connectionText'),
            peerList: document.getElementById('peerList'),
            emptyPeers: document.getElementById('emptyPeers'),
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            fileInput: document.getElementById('fileInput'),
            attachBtn: document.getElementById('attachBtn'),
            ratchetBar: document.getElementById('ratchetBar'),
            ratchetFill: document.getElementById('ratchetFill'),
            ratchetTimer: document.getElementById('ratchetTimer'),
            mediaViewer: document.getElementById('mediaViewer'),
            mediaViewerName: document.getElementById('mediaViewerName'),
            mediaViewerClose: document.getElementById('mediaViewerClose'),
            mediaViewerContent: document.getElementById('mediaViewerContent')
        };
    }

    function generatePeerId() {
        const arr = new Uint8Array(PEER_ID_LENGTH);
        crypto.getRandomValues(arr);
        return Array.from(arr).map(b => PEER_ID_CHARS[b % PEER_ID_CHARS.length]).join('');
    }

    function sanitizeDisplayName(name) {
        if (!name || typeof name !== 'string') return null;
        const cleaned = name.trim().replace(/[<>"'&]/g, '').substring(0, 24);
        return cleaned.length > 0 ? cleaned : null;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function scrollToBottom() {
        dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
    }

    // ===================== INIT FLOW =====================

    async function bootApp() {
        // Show loading for 1.8s then transition to welcome
        await sleep(1800);
        dom.loadingScreen.classList.add('fade-out');
        await sleep(600);
        dom.loadingScreen.classList.add('hidden');
        dom.welcomeScreen.classList.remove('hidden');
        dom.displayNameInput.focus();
    }

    function handleGetStarted() {
        const rawName = dom.displayNameInput.value.trim();
        const name = sanitizeDisplayName(rawName);
        if (!name) {
            dom.displayNameInput.style.borderColor = 'var(--error)';
            dom.displayNameInput.placeholder = 'Please enter a name';
            setTimeout(() => {
                dom.displayNameInput.style.borderColor = '';
                dom.displayNameInput.placeholder = 'ShadowAgent42';
            }, 2000);
            return;
        }
        state.displayName = name;
        dom.welcomeScreen.classList.add('hidden');
        dom.joinUserBadge.textContent = name;
        dom.joinModal.classList.remove('hidden');
    }

    // ===================== CONNECTION STATUS =====================

    async function showConnectionStatus(steps) {
        dom.connectionOverlay.classList.remove('hidden');
        dom.statusLines.textContent = '';

        for (const step of steps) {
            await sleep(280 + Math.random() * 300);
            const line = document.createElement('div');
            line.className = 'status-line';
            const prefix = step.error ? '[!]' : '[+]';
            line.innerHTML = `<span class="prefix">${prefix}</span>${escapeHtml(step.text)}`;
            if (step.success) line.classList.add('success');
            if (step.error) line.classList.add('error');
            dom.statusLines.appendChild(line);
            await sleep(20);
            line.classList.add('visible');
        }
    }

    function hideConnectionOverlay() {
        setTimeout(() => dom.connectionOverlay.classList.add('hidden'), 700);
    }

    function setConnectionStatus(status, text) {
        dom.connectionDot.className = 'status-dot ' + status;
        dom.connectionText.textContent = text;
    }

    // ===================== MESSAGES =====================

    function addSystemMessage(text, type = 'info') {
        const msg = document.createElement('div');
        msg.className = `system-msg ${type}`;
        msg.textContent = text;
        dom.messagesContainer.appendChild(msg);
        scrollToBottom();
    }

    function addChatMessage(sender, content, isSelf) {
        const wrapper = document.createElement('div');
        wrapper.className = `message ${isSelf ? 'self' : ''}`;

        const header = document.createElement('div');
        header.className = 'message-header';
        header.innerHTML = `
            <span class="message-sender">${escapeHtml(sender)}</span>
            <span class="message-time">${new Date().toLocaleTimeString()}</span>
        `;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = content;

        wrapper.appendChild(header);
        wrapper.appendChild(bubble);
        dom.messagesContainer.appendChild(wrapper);
        scrollToBottom();
    }

    function addImageMessage(sender, isSelf, blob, fileName) {
        const url = URL.createObjectURL(blob);
        const wrapper = document.createElement('div');
        wrapper.className = `message ${isSelf ? 'self' : ''}`;

        wrapper.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${escapeHtml(sender)}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            </div>
        `;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble image-bubble';

        const img = document.createElement('img');
        img.className = 'image-preview';
        img.src = url;
        img.alt = escapeHtml(fileName);
        img.addEventListener('click', () => openMediaViewer('image', url, fileName));

        bubble.appendChild(img);
        wrapper.appendChild(bubble);
        dom.messagesContainer.appendChild(wrapper);
        scrollToBottom();
    }

    function addVideoMessage(sender, isSelf, blob, fileName) {
        const url = URL.createObjectURL(blob);
        const wrapper = document.createElement('div');
        wrapper.className = `message ${isSelf ? 'self' : ''}`;

        wrapper.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${escapeHtml(sender)}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            </div>
        `;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble video-bubble';

        const video = document.createElement('video');
        video.className = 'video-preview';
        video.src = url;
        video.controls = false;
        video.addEventListener('click', () => openMediaViewer('video', url, fileName));

        bubble.appendChild(video);
        wrapper.appendChild(bubble);
        dom.messagesContainer.appendChild(wrapper);
        scrollToBottom();
    }

    function addFileMessage(sender, isSelf, fileData, blob) {
        const wrapper = document.createElement('div');
        wrapper.className = `message ${isSelf ? 'self' : ''}`;

        wrapper.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${escapeHtml(sender)}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            </div>
        `;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble file-bubble';
        bubble.innerHTML = `
            <div class="file-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
            </div>
            <div class="file-meta">
                <div class="file-name">${escapeHtml(fileData.name)}</div>
                <div class="file-size">${formatFileSize(fileData.size)}</div>
            </div>
        `;
        bubble.addEventListener('click', () => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = fileData.name;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        wrapper.appendChild(bubble);
        dom.messagesContainer.appendChild(wrapper);
        scrollToBottom();
    }

    // ===================== MEDIA VIEWER =====================

    function openMediaViewer(type, url, name) {
        dom.mediaViewerName.textContent = name;
        dom.mediaViewerContent.textContent = '';

        if (type === 'image') {
            const img = document.createElement('img');
            img.src = url;
            img.alt = name;
            dom.mediaViewerContent.appendChild(img);
        } else if (type === 'video') {
            const video = document.createElement('video');
            video.src = url;
            video.controls = true;
            video.autoplay = true;
            dom.mediaViewerContent.appendChild(video);
        }

        dom.mediaViewer.classList.remove('hidden');
    }

    function closeMediaViewer() {
        const video = dom.mediaViewerContent.querySelector('video');
        if (video) { video.pause(); video.src = ''; }
        dom.mediaViewer.classList.add('hidden');
        dom.mediaViewerContent.textContent = '';
    }

    // ===================== PEER LIST =====================

    function updatePeerList() {
        const peers = Array.from(state.peerNames.entries());
        dom.emptyPeers.style.display = peers.length === 0 ? 'flex' : 'none';

        const existing = new Set(
            Array.from(dom.peerList.querySelectorAll('.peer-item')).map(el => el.dataset.peerId)
        );

        peers.forEach(([id, name]) => {
            if (!existing.has(id)) {
                const item = document.createElement('div');
                item.className = 'peer-item';
                item.dataset.peerId = id;
                item.innerHTML = `
                    <div class="peer-avatar">${escapeHtml(name.charAt(0).toUpperCase())}</div>
                    <div>
                        <div class="peer-name">${escapeHtml(name)}</div>
                        <div class="peer-status">● online</div>
                    </div>
                `;
                dom.peerList.appendChild(item);
            }
        });

        dom.peerList.querySelectorAll('.peer-item').forEach(el => {
            if (!peers.some(([id]) => id === el.dataset.peerId)) el.remove();
        });
    }

    // ===================== ROOM OPERATIONS =====================

    async function createRoom() {
        try {
            state.peerId = generatePeerId();
            state.cryptoContext = await CryptoModule.createContext('NEWROOM');

            await showConnectionStatus([
                { text: 'Seeding entropy pool...' },
                { text: 'Generating X25519 keypair...' },
                { text: 'Initializing AES-256-GCM context...' },
                { text: 'Creating secure room...' },
                { text: 'Room initialized', success: true }
            ]);

            const roomId = await FirebaseAPI.createRoom(state.peerId, state.cryptoContext.publicKey, state.displayName);
            state.roomId = roomId;

            // Now recreate crypto context with the actual room code for signal encryption
            state.cryptoContext = await CryptoModule.createContext(roomId);
            // Re-register public key with correct signal key context
            // (public key is the same, only signal key changes)

            dom.roomCodeDisplay.innerHTML = `Room: <strong>${roomId}</strong>`;
            hideConnectionOverlay();
            setConnectionStatus('connecting', 'Waiting for peers...');

            await listenForSignals();
            startRatchet();
            startDummyTraffic();

            addSystemMessage(`Room created. Code: ${roomId}`, 'success');
            addSystemMessage('Share this code with trusted peers only.');
            state.isJoined = true;

        } catch (err) {
            console.error(err);
            await showConnectionStatus([
                { text: 'Failed to create room', error: true },
                { text: err.message, error: true }
            ]);
            setTimeout(hideConnectionOverlay, 2500);
        }
    }

    async function joinRoom() {
        const code = dom.roomCodeInput.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (code.length !== 8) {
            addSystemMessage('Invalid room code — must be 8 alphanumeric characters', 'error');
            return;
        }

        try {
            state.peerId = generatePeerId();
            state.cryptoContext = await CryptoModule.createContext(code);
            state.roomId = code;

            await showConnectionStatus([
                { text: 'Querying relay network...' },
                { text: 'Verifying room integrity...' },
                { text: 'Performing X25519 key exchange...' },
                { text: 'Deriving session keys via HKDF...' },
                { text: 'Activating forward secrecy...'},
                { text: 'Secure channel established.', success: true }
            ]);

            const room = await FirebaseAPI.joinRoom(state.roomId, state.peerId, state.cryptoContext.publicKey, state.displayName);

            if (!room) throw new Error('Room not found or has expired');
            if (room.locked) throw new Error('Room is locked due to too many failed attempts');

            dom.roomCodeDisplay.innerHTML = `Room: <strong>${state.roomId}</strong>`;
            hideConnectionOverlay();
            setConnectionStatus('connecting', 'Establishing connections...');

            await listenForSignals();
            await connectToPeers(room.peers);
            startRatchet();
            startDummyTraffic();

            addSystemMessage(`Joined room: ${state.roomId}`, 'success');
            state.isJoined = true;

        } catch (err) {
            console.error(err);
            await FirebaseAPI.incrementFailedAttempts(state.roomId);
            await showConnectionStatus([
                { text: 'Failed to join room', error: true },
                { text: err.message, error: true }
            ]);
            setTimeout(hideConnectionOverlay, 2500);
        }
    }

    // ===================== SIGNALING =====================

    async function listenForSignals() {
        state.unsubscribeSignals = FirebaseAPI.listenForSignals(
            state.roomId, state.peerId,
            async (signal) => { await handleSignal(signal); }
        );
    }

    async function handleSignal(signal) {
        try {
            const decrypted = await CryptoModule.decryptSignal(signal.encryptedBlob, state.cryptoContext);
            const data = JSON.parse(decrypted);

            if (data.type === 'offer') await handleOffer(data, signal.from);
            else if (data.type === 'answer') await handleAnswer(data, signal.from);
            else if (data.type === 'candidate') await handleCandidate(data, signal.from);
            else if (data.type === 'peer-info') {
                state.peerNames.set(signal.from, sanitizeDisplayName(data.name) || signal.from);
                updatePeerList();
            }
        } catch (err) {
            console.error('Signal handling error:', err);
        }
    }

    async function sendSignal(toPeerId, data) {
        const jitter = 80 + Math.random() * 400;
        await sleep(jitter);
        const encrypted = await CryptoModule.encryptSignal(JSON.stringify(data), state.cryptoContext);
        await FirebaseAPI.sendSignal(state.roomId, state.peerId, toPeerId, encrypted);
    }

    // ===================== WebRTC =====================

    async function connectToPeers(peers) {
        if (!peers || !peers.length) return;
        for (const peer of peers) {
            if (peer.id !== state.peerId) {
                await createConnection(peer.id, peer.publicKey);
            }
        }
    }

    async function createConnection(peerId, peerPublicKey) {
        if (state.connections.has(peerId)) return;

        const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
        state.connections.set(peerId, pc);

        const sharedSecret = await CryptoModule.deriveSharedSecret(
            state.cryptoContext.keyPair.privateKey, peerPublicKey
        );
        const sessionKeys = await CryptoModule.deriveSessionKeys(sharedSecret, state.peerId, peerId);

        pc.onicecandidate = async (e) => {
            if (e.candidate) {
                await sendSignal(peerId, { type: 'candidate', candidate: e.candidate.toJSON() });
            }
        };

        pc.onconnectionstatechange = () => {
            if (pc.connectionState === 'connected') {
                setConnectionStatus('connected', 'Secure connection active');
                updatePeerList();
            } else if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
                handlePeerDisconnect(peerId);
            }
        };

        const dc = pc.createDataChannel('blackkeep', { ordered: true });
        setupDataChannel(dc, peerId, sessionKeys);
        state.dataChannels.set(peerId, { channel: dc, keys: sessionKeys });

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await sendSignal(peerId, { type: 'offer', sdp: offer.sdp });
        await sendSignal(peerId, { type: 'peer-info', name: state.displayName });
    }

    async function handleOffer(data, fromPeerId) {
        let pc = state.connections.get(fromPeerId);
        if (!pc) {
            pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
            state.connections.set(fromPeerId, pc);

            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') setConnectionStatus('connected', 'Secure connection active');
                else if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) handlePeerDisconnect(fromPeerId);
            };
        }

        await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));

        const pending = state.pendingCandidates.get(fromPeerId) || [];
        for (const c of pending) await pc.addIceCandidate(new RTCIceCandidate(c));
        state.pendingCandidates.delete(fromPeerId);

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await sendSignal(fromPeerId, { type: 'answer', sdp: answer.sdp });
        await sendSignal(fromPeerId, { type: 'peer-info', name: state.displayName });

        pc.ondatachannel = async (e) => {
            const peerPubKey = await FirebaseAPI.getPeerPublicKey(state.roomId, fromPeerId);
            if (!peerPubKey) return;
            const secret = await CryptoModule.deriveSharedSecret(state.cryptoContext.keyPair.privateKey, peerPubKey);
            const keys = await CryptoModule.deriveSessionKeys(secret, state.peerId, fromPeerId);
            setupDataChannel(e.channel, fromPeerId, keys);
            state.dataChannels.set(fromPeerId, { channel: e.channel, keys });
        };
    }

    async function handleAnswer(data, fromPeerId) {
        const pc = state.connections.get(fromPeerId);
        if (pc) await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
    }

    async function handleCandidate(data, fromPeerId) {
        const pc = state.connections.get(fromPeerId);
        if (pc && pc.remoteDescription) {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } else {
            const pending = state.pendingCandidates.get(fromPeerId) || [];
            pending.push(data.candidate);
            state.pendingCandidates.set(fromPeerId, pending);
        }
    }

    function setupDataChannel(dc, peerId, sessionKeys) {
        dc.onopen = () => {
            setConnectionStatus('connected', 'Secure channel established');
            addSystemMessage(`${state.peerNames.get(peerId) || peerId} connected`, 'success');
            dom.ratchetBar.style.display = 'flex';
        };

        dc.onclose = () => handlePeerDisconnect(peerId);

        dc.onmessage = async (e) => {
            await handleDataChannelMessage(e.data, peerId, sessionKeys);
        };
    }

    async function handleDataChannelMessage(encryptedData, peerId, sessionKeys) {
        try {
            const decrypted = await CryptoModule.decryptMessage(encryptedData, sessionKeys.decryptionKey);
            const message = JSON.parse(decrypted);
            const senderName = state.peerNames.get(peerId) || peerId;

            if (message.type === 'chat') {
                addChatMessage(senderName, message.content, false);
            } else if (message.type === 'file') {
                const { fileData } = message;
                const blob = new Blob([new Uint8Array(fileData.data)], { type: fileData.mimeType || 'application/octet-stream' });

                // Verify integrity
                const hash = await CryptoModule.hashBuffer(await blob.arrayBuffer());
                if (hash !== fileData.hash) {
                    addSystemMessage('⚠ File integrity check failed — discarded', 'error');
                    return;
                }

                if (fileData.mimeType && fileData.mimeType.startsWith('image/')) {
                    addImageMessage(senderName, false, blob, fileData.name);
                } else if (fileData.mimeType && fileData.mimeType.startsWith('video/')) {
                    addVideoMessage(senderName, false, blob, fileData.name);
                } else {
                    addFileMessage(senderName, false, fileData, blob);
                }
            } else if (message.type === 'dummy') {
                // Discard — traffic analysis resistance
            }
        } catch (err) {
            console.error('Message decryption error:', err);
        }
    }

    // ===================== SEND =====================

    async function sendMessage() {
        const content = dom.messageInput.value.trim();
        if (!content || state.dataChannels.size === 0) return;

        const msg = { type: 'chat', content, timestamp: Date.now() };
        addChatMessage(state.displayName, content, true);
        dom.messageInput.value = '';
        await broadcastMessage(msg);
    }

    async function broadcastMessage(message) {
        const promises = [];
        state.dataChannels.forEach(({ channel, keys }) => {
            if (channel.readyState === 'open') {
                promises.push(
                    CryptoModule.encryptMessage(JSON.stringify(message), keys.encryptionKey)
                        .then(enc => channel.send(enc))
                        .catch(err => console.error('Send error:', err))
                );
            }
        });
        await Promise.all(promises);
    }

    async function sendFile(file) {
        if (file.size > MAX_FILE_SIZE) {
            addSystemMessage(`File exceeds ${MAX_FILE_SIZE / 1024 / 1024}MB limit`, 'error');
            return;
        }

        if (state.dataChannels.size === 0) {
            addSystemMessage('No peers connected', 'error');
            return;
        }

        const arrayBuffer = await file.arrayBuffer();
        const hash = await CryptoModule.hashBuffer(arrayBuffer);
        const mimeType = file.type || 'application/octet-stream';

        const fileData = {
            name: file.name,
            size: file.size,
            mimeType,
            hash,
            data: Array.from(new Uint8Array(arrayBuffer))
        };

        const msg = { type: 'file', fileData, timestamp: Date.now() };

        // Show locally
        const blob = new Blob([arrayBuffer], { type: mimeType });
        if (mimeType.startsWith('image/')) {
            addImageMessage(state.displayName, true, blob, file.name);
        } else if (mimeType.startsWith('video/')) {
            addVideoMessage(state.displayName, true, blob, file.name);
        } else {
            addFileMessage(state.displayName, true, fileData, blob);
        }

        await broadcastMessage(msg);
    }

    // ===================== RATCHET =====================

    function startRatchet() {
        if (state.ratchetTimer) clearInterval(state.ratchetTimer);
        if (state.countdownTimer) clearInterval(state.countdownTimer);

        state.ratchetCountdown = 60;
        updateRatchetUI();

        state.countdownTimer = setInterval(() => {
            state.ratchetCountdown = Math.max(0, state.ratchetCountdown - 1);
            updateRatchetUI();
        }, 1000);

        state.ratchetTimer = setInterval(async () => {
            state.ratchetCountdown = 60;
            await performRatchet();
        }, RATCHET_INTERVAL);
    }

    function updateRatchetUI() {
        if (dom.ratchetTimer) dom.ratchetTimer.textContent = state.ratchetCountdown + 's';
        if (dom.ratchetFill) {
            dom.ratchetFill.style.width = ((state.ratchetCountdown / 60) * 100) + '%';
        }
    }

    async function performRatchet() {
        const promises = [];
        state.dataChannels.forEach(async ({ keys }, peerId) => {
            promises.push(
                CryptoModule.ratchetKeys(keys).then(newKeys => {
                    const entry = state.dataChannels.get(peerId);
                    if (entry) entry.keys = newKeys;
                })
            );
        });
        await Promise.all(promises);
        addSystemMessage('Encryption keys rotated', 'success');
    }

    function startDummyTraffic() {
        if (state.dummyTrafficTimer) clearInterval(state.dummyTrafficTimer);
        state.dummyTrafficTimer = setInterval(async () => {
            if (state.dataChannels.size > 0) {
                const dummy = {
                    type: 'dummy',
                    padding: CryptoModule.generateRandomPadding(),
                    nonce: Date.now()
                };
                await broadcastMessage(dummy).catch(() => {});
            }
        }, DUMMY_TRAFFIC_INTERVAL);
    }

    // ===================== DISCONNECT =====================

    function handlePeerDisconnect(peerId) {
        const name = state.peerNames.get(peerId) || peerId;
        addSystemMessage(`${name} disconnected`);

        const pc = state.connections.get(peerId);
        if (pc) { try { pc.close(); } catch(e){} }

        state.connections.delete(peerId);
        state.dataChannels.delete(peerId);
        state.peerNames.delete(peerId);
        updatePeerList();

        if (state.connections.size === 0) {
            setConnectionStatus('connecting', 'Waiting for peers...');
            dom.ratchetBar.style.display = 'none';
        }
    }

    async function leaveRoom() {
        dom.purgeOverlay.classList.remove('hidden');

        // Stop timers
        [state.ratchetTimer, state.countdownTimer, state.dummyTrafficTimer].forEach(t => { if(t) clearInterval(t); });

        // Close connections
        state.connections.forEach(pc => { try { pc.close(); } catch(e){} });
        state.dataChannels.forEach(({ channel }) => { try { channel.close(); } catch(e){} });

        // Zeroize crypto
        if (state.cryptoContext) await CryptoModule.zeroizeContext(state.cryptoContext);

        // Unsubscribe listeners
        if (state.unsubscribeSignals) state.unsubscribeSignals();

        // Notify Firebase
        await FirebaseAPI.leaveRoom(state.roomId, state.peerId);

        // Clear state
        state.connections.clear();
        state.dataChannels.clear();
        state.peerNames.clear();
        state.pendingCandidates.clear();
        state.isJoined = false;
        state.roomId = null;
        state.peerId = null;
        state.cryptoContext = null;

        setTimeout(() => {
            dom.purgeOverlay.classList.add('hidden');
            // Go back to join/create screen (not welcome — name is remembered)
            dom.joinModal.classList.remove('hidden');
            dom.roomCodeDisplay.innerHTML = 'Room: <strong>--------</strong>';
            dom.messagesContainer.textContent = '';
            dom.peerList.querySelectorAll('.peer-item').forEach(el => el.remove());
            dom.emptyPeers.style.display = 'flex';
            dom.ratchetBar.style.display = 'none';
            setConnectionStatus('', 'Disconnected');
        }, 2000);
    }

    // ===================== UTILITIES =====================

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // ===================== INIT =====================

    function init() {
        initDOM();

        dom.getStartedBtn.addEventListener('click', handleGetStarted);
        dom.displayNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleGetStarted(); });

        dom.createBtn.addEventListener('click', () => {
            dom.joinModal.classList.add('hidden');
            createRoom();
        });

        dom.joinBtn.addEventListener('click', () => {
            dom.joinModal.classList.add('hidden');
            joinRoom();
        });

        dom.roomCodeInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { dom.joinModal.classList.add('hidden'); joinRoom(); }
        });

        dom.leaveBtn.addEventListener('click', leaveRoom);
        dom.sendBtn.addEventListener('click', sendMessage);

        dom.messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        dom.attachBtn.addEventListener('click', () => dom.fileInput.click());
        dom.fileInput.addEventListener('change', e => {
            if (e.target.files.length > 0) {
                sendFile(e.target.files[0]);
                e.target.value = '';
            }
        });

        dom.mediaViewerClose.addEventListener('click', closeMediaViewer);
        dom.mediaViewer.addEventListener('click', e => {
            if (e.target === dom.mediaViewer) closeMediaViewer();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeMediaViewer();
        });

        window.addEventListener('beforeunload', () => {
            if (state.isJoined) FirebaseAPI.leaveRoom(state.roomId, state.peerId);
        });

        // Boot sequence
        bootApp();
    }

    return { init };
})();

document.addEventListener('DOMContentLoaded', BlackKeep.init);
</script>
</body>
</html>
